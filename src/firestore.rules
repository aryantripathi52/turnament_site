
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and reuse of logic.
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getRole(userId) {
      // Use exists() to avoid errors on non-existent documents.
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getRole(request.auth.uid) == 'admin';
    }

    // Secure user data: Users can only see their own profile. Admins can see any.
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // Only admins can list all users.
      allow create: if isOwner(userId); // A user can create their own profile.
      allow update: if isOwner(userId); // A user can update their own profile.
      allow delete: if isOwner(userId) || isAdmin();

      // Subcollections for user-specific tournament data.
      match /joinedTournaments/{tournamentId} {
          // A user can fully manage their own joined tournament records.
          // Admins can read them for management purposes.
          allow read, write, delete: if isOwner(userId);
          allow list: if isOwner(userId) || isAdmin();
      }
      match /wonTournaments/{tournamentId} {
          // A user can read the tournaments they have won.
          // Admins can write to this collection to award prizes.
          allow read, list: if isOwner(userId) || isAdmin();
          allow write: if isAdmin();
      }
    }

    // Tournaments are public to view, but only admins can modify them.
    match /tournaments/{tournamentId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();

      // Tournament Registrations subcollection
      match /registrations/{registrationId} {
        // Any signed-in user can read the list of registrations to see who has joined.
        allow read, list: if isSignedIn();
        // A player can create their own registration.
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        // Only an admin can delete a registration.
        allow delete: if isAdmin();
        // No updates allowed to prevent tampering.
        allow update: if false;
      }
    }

    // Announcements are public to view, only admins can modify.
    match /announcements/{announcementId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // Highlights are public to view, only admins can modify.
    match /highlights/{highlightId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Simplified rule for adding coin requests.
    match /addCoinRequests/{requestId} {
      // Players can only create requests for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Players can only list/get their own requests by querying their userId.
      allow get: if isOwner(request.resource.data.userId);
      allow list: if request.query.where.userId == request.auth.uid;
      // Admins have full read/write access to all requests.
      allow read, write, list: if isAdmin();
    }

    // Simplified rule for withdrawing coin requests.
    match /withdrawCoinRequests/{requestId} {
      // Players can only create requests for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
       // Players can only list/get their own requests by querying their userId.
      allow get: if isOwner(request.resource.data.userId);
      allow list: if request.query.where.userId == request.auth.uid;
      // Admins have full read/write access to all requests.
      allow read, write, list: if isAdmin();
    }

    // Categories are public to view, only admins can modify.
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin(); 
    }
  }
}
